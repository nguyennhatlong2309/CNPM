<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapbox Autocomplete HCM</title>

    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <style>
      #searchBox {
        width: 300px;
        padding: 8px;
        margin-bottom: 4px;
      }
      #suggestions {
        width: 300px;
        background: white;
        border: 1px solid #ddd;
        list-style: none;
        padding: 0;
        margin-top: 0;
        position: absolute;
        z-index: 999;
      }
      #suggestions li {
        padding: 6px 10px;
        cursor: pointer;
      }
      #suggestions li:hover {
        background: #f0f0f0;
      }
      #map {
        width: 100%;
        height: 450px;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <h2>Autocomplete ‚Äì Gi·ªõi h·∫°n trong TP.HCM + T√¨m ch√≠nh x√°c s·ªë nh√†</h2>

    <input id="searchBox" type="text" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm..." />
    <ul id="suggestions"></ul>

    <div id="map"></div>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibG9uZ25oYXQyMzkiLCJhIjoiY21pMmc0MGk1MWtndjJqb3FlYmZ4dDFucSJ9.50MnkL8QdWHEcT3inc6tqw";

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [106.700981, 10.776889],
        zoom: 12,
      });

      let marker;

      // BBOX TP.HCM
      const HCM_BBOX = "106.3650,10.3450,106.9845,11.1600";
      const HCM_CENTER = "106.700981,10.776889";

      // Mapbox fetch
      async function fetchSuggestions(query) {
        const url =
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json` +
          `?types=address` +
          `&autocomplete=true` +
          `&country=vn` +
          `&bbox=${HCM_BBOX}` +
          `&proximity=${HCM_CENTER}` +
          `&access_token=${mapboxgl.accessToken}`;

        const res = await fetch(url);
        const data = await res.json();
        return data.features;
      }

      // Google fallback
      async function googleGeocode(address) {
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(
          address
        )}&key=YOUR_GOOGLE_KEY`;

        const res = await fetch(url);
        const data = await res.json();

        if (data.status === "OK") {
          const loc = data.results[0].geometry.location;
          return {
            lng: loc.lng,
            lat: loc.lat,
            source: "google",
          };
        }
        return null;
      }

      // Autocomplete x·ª≠ l√Ω
      document
        .getElementById("searchBox")
        .addEventListener("input", async (e) => {
          const text = e.target.value.trim();
          const list = document.getElementById("suggestions");
          list.innerHTML = "";

          if (text.length < 2) return;

          const results = await fetchSuggestions(text);

          results.forEach((place) => {
            const li = document.createElement("li");
            li.textContent = place.place_name;

            li.onclick = async () => {
              let [lng, lat] = place.geometry.coordinates;

              // üî• Ki·ªÉm tra c√≥ s·ªë nh√† th·∫≠t kh√¥ng (Regex)
              const hasRealHouseNumber = /^[0-9]+\s+/.test(place.place_name);

              let finalLng = lng;
              let finalLat = lat;
              let source = "mapbox";

              // ‚ùó Mapbox kh√¥ng c√≥ s·ªë nh√† ‚Üí fallback Google
              if (!hasRealHouseNumber) {
                const googleData = await googleGeocode(place.place_name);
                if (googleData) {
                  finalLng = googleData.lng;
                  finalLat = googleData.lat;
                  source = "google";
                }
              }

              map.flyTo({ center: [finalLng, finalLat], zoom: 16 });

              if (marker) marker.remove();
              marker = new mapboxgl.Marker()
                .setLngLat([finalLng, finalLat])
                .addTo(map);

              console.log("Marker from:", source);

              document.getElementById("searchBox").value = place.place_name;
              list.innerHTML = "";
            };

            list.appendChild(li);
          });
        });
    </script>
  </body>
</html>
